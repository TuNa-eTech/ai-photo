openapi: 3.0.3
info:
  title: AI Image Stylist API (Public - Templates Read Only)
  description: |
    Public OpenAPI specification for end-users.
    Scope: Users can only GET templates information. No POST/PUT/DELETE exposed here.
    Documentation-driven: see
      - .documents/workflows/run-tests.md
      - .documents/troubleshooting/db-auth.md
  version: 1.0.1

servers:
  - url: http://localhost:8080
    description: Backend API base URL (local/dev)

paths:
  /v1/templates:
    get:
      summary: Lấy danh sách template AI (Public)
      description: |
        Trả về danh sách Templates cho người dùng cuối (public + published).
        Lưu ý: Prompt không được trả về trong API công khai.
      tags:
        - Templates
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            default: 20
          description: Số lượng bản ghi trả về
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Vị trí bắt đầu (bỏ qua số bản ghi đầu)
        - in: query
          name: q
          schema:
            type: string
          description: Từ khoá tìm kiếm theo name/slug
        - in: query
          name: tags
          schema:
            type: string
          description: Danh sách tag slug, phân tách bởi dấu phẩy (ví dụ "anime,portrait")
        - in: query
          name: sort
          schema:
            type: string
            enum:
              - newest
              - popular
              - name
            default: newest
          description: Tiêu chí sắp xếp (newest|popular|name)
      responses:
        '200':
          description: Danh sách template (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeTemplatesList'
              example:
                success: true
                data:
                  templates:
                    - id: "anime-style"
                      name: "Phong cách Anime"
                      thumbnail_url: "https://example.com/templates/anime-thumb.jpg"
                      published_at: "2025-10-20T07:30:00Z"
                      usage_count: 120
                    - id: "cartoon"
                      name: "Cartoon Style"
                meta:
                  requestId: "example-request-id"
                  timestamp: "2025-10-24T07:30:00Z"
        '401':
          description: Chưa xác thực (envelope error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
      security:
        - bearerAuth: []

  /v1/templates/trending:
    get:
      summary: Lấy danh sách template đang thịnh hành (Trending)
      description: |
        Trả về danh sách Templates có lượt sử dụng cao (trending).
        Chỉ trả về templates với usage_count >= 500, sắp xếp theo usage_count giảm dần.
        Phù hợp cho màn hình Home để hiển thị templates hot nhất.
      tags:
        - Templates
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
          description: Số lượng trending templates trả về (tối đa 50)
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Vị trí bắt đầu (phân trang)
      responses:
        '200':
          description: Danh sách trending templates (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeTemplatesList'
              example:
                success: true
                data:
                  templates:
                    - id: "5193b903-9595-4b81-9080-01122eb51166"
                      name: "Hyper-Realistic Portrait Pro"
                      thumbnail_url: "http://localhost:8080/public/thumbnails/realistic-portrait-pro-thumbnail-1761475486057.jpeg"
                      published_at: "2025-10-26T15:31:41.255Z"
                      usage_count: 3120
                    - id: "e000b2d3-9928-425a-b46b-45dc387be647"
                      name: "Watercolor Fantasy Art"
                      thumbnail_url: "http://localhost:8080/public/thumbnails/watercolor-fantasy-art-thumbnail-1761475478270.jpeg"
                      usage_count: 2340
                    - id: "a6f48613-7897-4086-acd6-54264d77e5f6"
                      name: "Steampunk Vintage Style"
                      thumbnail_url: "http://localhost:8080/public/thumbnails/steampunk-vintage-thumbnail-1761475400197.jpeg"
                      usage_count: 2100
                meta:
                  requestId: "trending-request-id"
                  timestamp: "2025-10-26T15:45:00Z"
        '401':
          description: Chưa xác thực (envelope error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
      security:
        - bearerAuth: []

  /v1/images/process:
    post:
      summary: Xử lý ảnh với AI template (Async với FCM Push Notification)
      description: |
        Xử lý ảnh gốc với template AI đã chọn (async mode).
        Backend tạo job và xử lý trong background, gửi push notification khi hoàn tất.
        
        **Flow:**
        1. Client gửi ảnh gốc (base64), template_id và device_token (FCM)
        2. Backend tạo job và trả về job_id ngay lập tức (202 Accepted)
        3. Backend xử lý trong background với BullMQ
        4. Backend gửi push notification khi xong
        5. Client nhận push, gọi GET /v1/images/jobs/{job_id} để lấy kết quả
        6. Client lưu ảnh locally
        
        **Response time:** < 500ms (job creation)
        **Processing time:** 5-30 seconds (background)
        **Max image size:** 10MB (decoded)
      tags:
        - Images
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessImageRequestAsync'
            example:
              template_id: "anime-style-uuid"
              image_base64: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
              options:
                width: 1024
                height: 1024
                quality: "standard"
      responses:
        '202':
          description: Job đã được tạo và đang xử lý (Accepted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeJobCreated'
              example:
                success: true
                data:
                  job_id: "job-uuid-123"
                  status: "pending"
                  estimated_time_seconds: 15
                  message: "Processing started. You will receive a notification when complete."
                meta:
                  requestId: "req_abc123xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '400':
          description: Yêu cầu không hợp lệ (invalid format, dimensions, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "invalid_image_format"
                  message: "Image format not supported. Please use JPEG or PNG."
                  details:
                    supported_formats: ["image/jpeg", "image/png"]
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '401':
          description: Chưa xác thực
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "unauthorized"
                  message: "Please sign in again"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '404':
          description: Template không tồn tại
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "invalid_template"
                  message: "Template with ID 'xyz' not found or not published"
                  details:
                    template_id: "xyz"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '413':
          description: Ảnh quá lớn
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "image_too_large"
                  message: "Image is too large. Maximum 10MB."
                  details:
                    max_size_mb: 10
                    current_size_mb: 15
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '422':
          description: Nội dung không phù hợp (content policy violation)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "inappropriate_content"
                  message: "This image cannot be processed due to content policy"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '403':
          description: Không đủ credits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "insufficient_credits"
                  message: "Insufficient credits. Please purchase more credits to continue."
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '429':
          description: Vượt quá giới hạn (rate limit exceeded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "rate_limit_exceeded"
                  message: "Monthly limit reached. Upgrade to continue."
                  details:
                    limit: 50
                    reset_at: "2025-11-01T00:00:00Z"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '502':
          description: Gemini API lỗi
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "gemini_api_error"
                  message: "AI service unavailable. Please try again."
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
        '504':
          description: Timeout (processing quá lâu)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "processing_timeout"
                  message: "Processing took too long. Please try again."
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:30:45Z"
      security:
        - bearerAuth: []

  /v1/images/jobs/{jobId}:
    get:
      summary: Lấy trạng thái và kết quả của job
      description: |
        Lấy thông tin chi tiết về job xử lý ảnh, bao gồm trạng thái và kết quả (nếu đã hoàn tất).
        
        **Use cases:**
        - Polling để check status khi chưa nhận push notification
        - Fetch kết quả sau khi nhận push notification
        - Xem lại kết quả của job cũ (trong 24h)
      tags:
        - Images
      parameters:
        - in: path
          name: jobId
          required: true
          schema:
            type: string
            format: uuid
          description: UUID của job
      responses:
        '200':
          description: Thông tin job (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeJobStatus'
              examples:
                pending:
                  summary: Job đang chờ xử lý
                  value:
                    success: true
                    data:
                      job_id: "job-uuid-123"
                      status: "pending"
                      created_at: "2025-10-27T10:00:00Z"
                    meta:
                      requestId: "req_xyz"
                      timestamp: "2025-10-27T10:00:05Z"
                processing:
                  summary: Job đang xử lý
                  value:
                    success: true
                    data:
                      job_id: "job-uuid-123"
                      status: "processing"
                      created_at: "2025-10-27T10:00:00Z"
                      started_at: "2025-10-27T10:00:02Z"
                    meta:
                      requestId: "req_xyz"
                      timestamp: "2025-10-27T10:00:10Z"
                completed:
                  summary: Job hoàn tất
                  value:
                    success: true
                    data:
                      job_id: "job-uuid-123"
                      status: "completed"
                      created_at: "2025-10-27T10:00:00Z"
                      started_at: "2025-10-27T10:00:02Z"
                      completed_at: "2025-10-27T10:00:15Z"
                      result:
                        processed_image_base64: "data:image/jpeg;base64,..."
                        metadata:
                          template_id: "anime-style"
                          template_name: "Anime Style"
                          model_used: "imagen-3-fast"
                          generation_time_ms: 8500
                          processed_dimensions:
                            width: 1024
                            height: 1024
                    meta:
                      requestId: "req_xyz"
                      timestamp: "2025-10-27T10:00:16Z"
                failed:
                  summary: Job thất bại
                  value:
                    success: true
                    data:
                      job_id: "job-uuid-123"
                      status: "failed"
                      created_at: "2025-10-27T10:00:00Z"
                      completed_at: "2025-10-27T10:00:15Z"
                      error:
                        code: "gemini_api_error"
                        message: "AI service unavailable"
                    meta:
                      requestId: "req_xyz"
                      timestamp: "2025-10-27T10:00:16Z"
        '404':
          description: Job không tồn tại hoặc đã hết hạn
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "job_not_found"
                  message: "Job not found or expired (jobs expire after 24 hours)"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:00:00Z"
        '403':
          description: Không có quyền truy cập job này
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "forbidden"
                  message: "You don't have permission to access this job"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:00:00Z"
      security:
        - bearerAuth: []

  /v1/images/jobs:
    get:
      summary: Lấy danh sách jobs của user
      description: |
        Lấy danh sách tất cả jobs xử lý ảnh của user hiện tại.
        Jobs được sắp xếp theo thời gian tạo (mới nhất trước).
        Chỉ trả về metadata (không có kết quả ảnh).
      tags:
        - Images
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Số lượng jobs trả về
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Vị trí bắt đầu
        - in: query
          name: status
          schema:
            type: string
            enum:
              - pending
              - processing
              - completed
              - failed
          description: Lọc theo trạng thái
      responses:
        '200':
          description: Danh sách jobs (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeJobsList'
              example:
                success: true
                data:
                  jobs:
                    - job_id: "job-uuid-123"
                      status: "completed"
                      template_id: "anime-style"
                      created_at: "2025-10-27T10:00:00Z"
                      completed_at: "2025-10-27T10:00:15Z"
                    - job_id: "job-uuid-456"
                      status: "pending"
                      template_id: "portrait-style"
                      created_at: "2025-10-27T09:50:00Z"
                  total: 2
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-10-27T10:05:00Z"
      security:
        - bearerAuth: []

  /v1/credits/balance:
    get:
      summary: Lấy số credits hiện tại của user
      description: |
        Trả về số credits hiện tại của user đã đăng nhập.
        Credits được sử dụng để process images (mỗi lần process trừ 1 credit).
      tags:
        - Credits
      responses:
        '200':
          description: Số credits hiện tại (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeCreditsBalance'
              example:
                success: true
                data:
                  credits: 5
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"
        '401':
          description: Chưa xác thực
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
        '404':
          description: User không tồn tại
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
      security:
        - bearerAuth: []

  /v1/credits/transactions:
    get:
      summary: Lấy lịch sử giao dịch credits
      description: |
        Trả về lịch sử các giao dịch credits của user (purchase, usage, bonus).
        Được sắp xếp theo thời gian tạo (mới nhất trước).
      tags:
        - Credits
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Số lượng transactions trả về
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Vị trí bắt đầu (phân trang)
      responses:
        '200':
          description: Lịch sử giao dịch (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeTransactionHistory'
              example:
                success: true
                data:
                  transactions:
                    - id: "tx-uuid-123"
                      type: "purchase"
                      amount: 10
                      product_id: "com.aiimagestylist.credits.starter"
                      status: "completed"
                      created_at: "2025-11-09T10:00:00Z"
                    - id: "tx-uuid-456"
                      type: "usage"
                      amount: -1
                      product_id: null
                      status: "completed"
                      created_at: "2025-11-09T09:30:00Z"
                  meta:
                    total: 15
                    limit: 20
                    offset: 0
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"
        '401':
          description: Chưa xác thực
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
      security:
        - bearerAuth: []

  /v1/credits/purchase:
    post:
      summary: Mua credits qua In-App Purchase
      description: |
        Xử lý purchase từ App Store, verify JWT transaction từ StoreKit 2,
        và thêm credits vào tài khoản user.
        
        **Flow:**
        1. User mua IAP product trên iOS app
        2. App lấy JWT transaction data từ `Transaction.jwsRepresentation`
        3. App gửi JWT transaction data và product_id lên server
        4. Server verify JWT, check idempotency, và thêm credits
        5. Server trả về số credits đã thêm và balance mới
        
        **Idempotency:** Nếu transaction đã được xử lý trước đó (check bằng `original_transaction_id`),
        server sẽ trả về success nhưng không thêm credits lại.
      tags:
        - Credits
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseRequest'
            example:
              transaction_data: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
              product_id: "com.aiimagestylist.credits.starter"
      responses:
        '200':
          description: Purchase thành công (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopePurchaseResponse'
              example:
                success: true
                data:
                  transaction_id: "tx-uuid-123"
                  credits_added: 10
                  new_balance: 12
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"
        '400':
          description: Request không hợp lệ (invalid JWT, product ID mismatch, etc.)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "invalid_transaction_data"
                  message: "Invalid transaction data: Unable to parse JWT"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"
        '401':
          description: Chưa xác thực
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
        '404':
          description: Product không tồn tại hoặc user không tồn tại
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeError'
              example:
                success: false
                error:
                  code: "product_not_found"
                  message: "IAP product not found"
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"
      security:
        - bearerAuth: []

  /v1/iap/products:
    get:
      summary: Lấy danh sách IAP products (Public)
      description: |
        Trả về danh sách các IAP products đang active.
        Endpoint này là public (không cần authentication).
        Phù hợp để hiển thị danh sách gói mua trong app.
      tags:
        - IAP
      responses:
        '200':
          description: Danh sách IAP products (envelope)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeIAPProductsList'
              example:
                success: true
                data:
                  products:
                    - id: "product-uuid-1"
                      product_id: "com.aiimagestylist.credits.starter"
                      name: "10 Credits"
                      description: "Buy 10 credits"
                      credits: 10
                      price: 0.99
                      currency: "USD"
                      display_order: 1
                    - id: "product-uuid-2"
                      product_id: "com.aiimagestylist.credits.popular"
                      name: "50 Credits"
                      description: "Buy 50 credits"
                      credits: 50
                      price: 4.99
                      currency: "USD"
                      display_order: 2
                    - id: "product-uuid-3"
                      product_id: "com.aiimagestylist.credits.bestvalue"
                      name: "100 Credits"
                      description: "Buy 100 credits"
                      credits: 100
                      price: 8.99
                      currency: "USD"
                      display_order: 3
                meta:
                  requestId: "req_xyz"
                  timestamp: "2025-11-09T10:00:00Z"

components:
  schemas:
    Template:
      type: object
      properties:
        id:
          type: string
          example: "anime-style"
        name:
          type: string
          example: "Phong cách Anime"
        thumbnail_url:
          type: string
          format: uri
          example: "https://your-storage/templates/anime-style-thumb.jpg"
        published_at:
          type: string
          format: date-time
          example: "2025-10-20T07:30:00Z"
        usage_count:
          type: integer
          minimum: 0
          example: 120345
      required:
        - id
        - name

    TemplatesList:
      type: object
      properties:
        templates:
          type: array
          items:
            $ref: '#/components/schemas/Template'
      required:
        - templates

    APIError:
      type: object
      properties:
        code:
          type: string
          example: "unauthorized"
        message:
          type: string
          example: "Unauthorized. Invalid, expired, or missing token."
        details:
          type: object
          additionalProperties: true

    Meta:
      type: object
      properties:
        requestId:
          type: string
          example: "8f9a1b2c3d4e5f6a"
        timestamp:
          type: string
          format: date-time
          example: "2025-10-24T07:30:00Z"

    EnvelopeTemplatesList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/TemplatesList'
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/Meta'

    EnvelopeError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/Meta'

    # Image Processing Schemas (Async với FCM)
    ProcessImageRequestAsync:
      type: object
      required:
        - template_id
        - image_base64
      properties:
        template_id:
          type: string
          description: UUID của template AI
          example: "anime-style-uuid"
        image_base64:
          type: string
          description: Ảnh gốc encoded base64, có thể có data URI prefix
          example: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
        device_token:
          type: string
          description: FCM device token để gửi push notification (optional)
          example: "fcm-token-abc123..."
        options:
          type: object
          properties:
            width:
              type: integer
              minimum: 512
              maximum: 2048
              default: 1024
              description: Chiều rộng ảnh output (phải là bội số của 64)
            height:
              type: integer
              minimum: 512
              maximum: 2048
              default: 1024
              description: Chiều cao ảnh output (phải là bội số của 64)
            quality:
              type: string
              enum:
                - standard
                - high
              default: standard
              description: Chất lượng ảnh output
    
    JobCreatedData:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          description: UUID của job
          example: "job-uuid-123"
        status:
          type: string
          enum:
            - pending
          description: Trạng thái job lúc tạo (luôn là pending)
          example: "pending"
        estimated_time_seconds:
          type: integer
          description: Thời gian xử lý ước tính (seconds)
          example: 15
        message:
          type: string
          description: Thông báo cho user
          example: "Processing started. You will receive a notification when complete."
      required:
        - job_id
        - status
        - estimated_time_seconds
    
    EnvelopeJobCreated:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/JobCreatedData'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data
        - meta
    
    JobStatusData:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          example: "job-uuid-123"
        status:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
          example: "completed"
        created_at:
          type: string
          format: date-time
          example: "2025-10-27T10:00:00Z"
        started_at:
          type: string
          format: date-time
          example: "2025-10-27T10:00:02Z"
        completed_at:
          type: string
          format: date-time
          example: "2025-10-27T10:00:15Z"
        result:
          type: object
          description: Kết quả xử lý (chỉ có khi status = completed)
          properties:
            processed_image_base64:
              type: string
              example: "data:image/jpeg;base64,..."
            metadata:
              $ref: '#/components/schemas/ProcessImageMetadata'
        error:
          type: object
          description: Thông tin lỗi (chỉ có khi status = failed)
          properties:
            code:
              type: string
              example: "gemini_api_error"
            message:
              type: string
              example: "AI service unavailable"
      required:
        - job_id
        - status
        - created_at
    
    EnvelopeJobStatus:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/JobStatusData'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data
        - meta
    
    JobListItem:
      type: object
      properties:
        job_id:
          type: string
          format: uuid
          example: "job-uuid-123"
        status:
          type: string
          enum:
            - pending
            - processing
            - completed
            - failed
          example: "completed"
        template_id:
          type: string
          example: "anime-style"
        created_at:
          type: string
          format: date-time
          example: "2025-10-27T10:00:00Z"
        completed_at:
          type: string
          format: date-time
          example: "2025-10-27T10:00:15Z"
      required:
        - job_id
        - status
        - template_id
        - created_at
    
    JobsListData:
      type: object
      properties:
        jobs:
          type: array
          items:
            $ref: '#/components/schemas/JobListItem'
        total:
          type: integer
          description: Tổng số jobs
          example: 25
      required:
        - jobs
        - total
    
    EnvelopeJobsList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/JobsListData'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data
        - meta

    ImageDimensions:
      type: object
      properties:
        width:
          type: integer
          example: 1920
        height:
          type: integer
          example: 1080
      required:
        - width
        - height

    ProcessImageMetadata:
      type: object
      properties:
        template_id:
          type: string
          example: "anime-style-uuid"
        template_name:
          type: string
          example: "Anime Style"
        model_used:
          type: string
          example: "imagen-3-fast"
        generation_time_ms:
          type: integer
          description: Thời gian xử lý (milliseconds)
          example: 8500
        original_dimensions:
          $ref: '#/components/schemas/ImageDimensions'
        processed_dimensions:
          $ref: '#/components/schemas/ImageDimensions'
      required:
        - template_id
        - template_name
        - model_used
        - generation_time_ms

    ProcessImageResult:
      type: object
      properties:
        processed_image_base64:
          type: string
          description: Ảnh đã xử lý encoded base64 với data URI prefix
          example: "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
        metadata:
          $ref: '#/components/schemas/ProcessImageMetadata'
      required:
        - processed_image_base64
        - metadata

    EnvelopeProcessImageSuccess:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/ProcessImageResult'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data
        - meta

    # Credits & IAP Schemas
    CreditsBalanceResponse:
      type: object
      properties:
        credits:
          type: integer
          minimum: 0
          description: Số credits hiện tại
          example: 5
      required:
        - credits

    EnvelopeCreditsBalance:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/CreditsBalanceResponse'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "tx-uuid-123"
        type:
          type: string
          enum:
            - purchase
            - usage
            - bonus
          description: Loại giao dịch
          example: "purchase"
        amount:
          type: integer
          description: Số credits (positive cho purchase/bonus, negative cho usage)
          example: 10
        product_id:
          type: string
          nullable: true
          description: IAP product ID (chỉ có khi type = purchase)
          example: "com.aiimagestylist.credits.starter"
        status:
          type: string
          enum:
            - pending
            - completed
            - failed
            - refunded
          example: "completed"
        created_at:
          type: string
          format: date-time
          example: "2025-11-09T10:00:00Z"
      required:
        - id
        - type
        - amount
        - status
        - created_at

    TransactionHistoryResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        meta:
          type: object
          properties:
            total:
              type: integer
              example: 15
            limit:
              type: integer
              example: 20
            offset:
              type: integer
              example: 0
          required:
            - total
            - limit
            - offset
      required:
        - transactions
        - meta

    EnvelopeTransactionHistory:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/TransactionHistoryResponse'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data

    PurchaseRequest:
      type: object
      required:
        - transaction_data
        - product_id
      properties:
        transaction_data:
          type: string
          description: JWT transaction data từ StoreKit 2 (Transaction.jwsRepresentation)
          example: "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
        product_id:
          type: string
          description: Apple IAP product identifier
          example: "com.aiimagestylist.credits.starter"

    PurchaseResponse:
      type: object
      properties:
        transaction_id:
          type: string
          format: uuid
          description: ID của transaction trong database
          example: "tx-uuid-123"
        credits_added:
          type: integer
          description: Số credits đã thêm vào tài khoản
          example: 10
        new_balance:
          type: integer
          description: Số credits mới sau khi thêm
          example: 12
      required:
        - transaction_id
        - credits_added
        - new_balance

    EnvelopePurchaseResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/PurchaseResponse'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data

    IAPProduct:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "product-uuid-1"
        product_id:
          type: string
          description: Apple IAP product identifier
          example: "com.aiimagestylist.credits.starter"
        name:
          type: string
          description: Tên hiển thị của product
          example: "10 Credits"
        description:
          type: string
          nullable: true
          description: Mô tả product
          example: "Buy 10 credits"
        credits:
          type: integer
          description: Số credits trong gói
          example: 10
        price:
          type: number
          format: decimal
          nullable: true
          description: Giá tiền (optional, có thể lấy từ Apple)
          example: 0.99
        currency:
          type: string
          nullable: true
          description: Mã tiền tệ
          example: "USD"
        display_order:
          type: integer
          description: Thứ tự hiển thị
          example: 1
      required:
        - id
        - product_id
        - name
        - credits
        - display_order

    IAPProductsListResponse:
      type: object
      properties:
        products:
          type: array
          items:
            $ref: '#/components/schemas/IAPProduct'
      required:
        - products

    EnvelopeIAPProductsList:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/IAPProductsListResponse'
        meta:
          $ref: '#/components/schemas/Meta'
      required:
        - success
        - data

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Firebase ID token (local có thể là DevAuth token).
