# File Upload System

Last updated: 2025-10-26

## Overview

Template thumbnail upload system with automatic file cleanup and static serving.

## Architecture

### Upload Flow
1. User uploads thumbnail via Web CMS form
2. Frontend sends multipart/form-data to backend
3. Backend validates file (type, size)
4. Backend saves file to disk with unique filename
5. Backend deletes old thumbnail if exists
6. Backend updates database with new URL
7. File served via static file server

### Storage
- **Location**: `server/public/thumbnails/`
- **Filename pattern**: `{slug}-{kind}-{timestamp}.{ext}`
  - Example: `anime-portrait-thumbnail-1761451580086.jpg`
- **URL pattern**: `http://localhost:8080/public/thumbnails/{filename}`

### File Cleanup
- **On upload**: Old thumbnail automatically deleted
- **On template delete**: All associated files deleted
- **Implementation**: `fs.unlink()` with try-catch for safety

## Implementation

### Backend (NestJS)

#### Dependencies
```json
{
  "@nestjs/platform-express": "^11.1.7",
  "@nestjs/serve-static": "^5.0.4",
  "multer": "^2.0.2",
  "@types/multer": "^2.0.0"
}
```

#### File Upload Endpoint
```typescript
// POST /v1/admin/templates/{slug}/assets
@Post(':slug/assets')
@UseInterceptors(FileInterceptor('file'))
async uploadAsset(
  @Param('slug') slug: string,
  @Body('kind') kind: string,
  @UploadedFile() file: Express.Multer.File,
) {
  return this.templatesService.uploadAsset(slug, kind as AssetKind, file);
}
```

#### Service Logic
```typescript
async uploadAsset(slug: string, kind: AssetKind, file: Express.Multer.File) {
  // Validate file type and size
  // Delete old thumbnail if exists
  if (kind === AssetKind.THUMBNAIL && template.thumbnailUrl) {
    const oldFilename = path.basename(new URL(template.thumbnailUrl).pathname);
    await fs.unlink(path.join(uploadDir, oldFilename));
  }
  // Save new file
  await fs.writeFile(filePath, file.buffer);
  // Update database
  await prisma.template.update({ 
    where: { slug }, 
    data: { thumbnailUrl: fileUrl } 
  });
}
```

#### Static File Serving
```typescript
// app.module.ts
ServeStaticModule.forRoot({
  rootPath: join(process.cwd(), 'public'),
  serveRoot: '/public',
  serveStaticOptions: {
    index: false, // Don't look for index.html
  },
})
```

### Frontend (React)

#### Form Component
```typescript
// TemplateFormDialog.tsx
const [thumbnailFile, setThumbnailFile] = useState<File | null>(null);
const [thumbnailPreview, setThumbnailPreview] = useState<string | null>(null);

const handleThumbnailChange = (event: React.ChangeEvent<HTMLInputElement>) => {
  const file = event.target.files?.[0];
  // Validate type and size
  setThumbnailFile(file);
  // Create preview
  const reader = new FileReader();
  reader.onloadend = () => setThumbnailPreview(reader.result as string);
  reader.readAsDataURL(file);
};
```

#### Upload API Call
```typescript
// templates.ts
export async function uploadTemplateAsset(
  slug: string,
  request: UploadAssetRequest
): Promise<TemplateAsset> {
  const formData = new FormData();
  formData.append('kind', request.kind);
  formData.append('file', request.file);

  const axios = apiClient.getAxiosInstance();
  const response = await axios.post(
    `/v1/admin/templates/${slug}/assets`,
    formData,
    { headers: { 'Content-Type': 'multipart/form-data' } }
  );
  return response.data;
}
```

## Validation

### File Type
- Allowed: `image/jpeg`, `image/jpg`, `image/png`, `image/webp`, `image/gif`
- Rejected: All other MIME types

### File Size
- Maximum: 5MB (5 * 1024 * 1024 bytes)
- Larger files rejected with BadRequestException

### Slug Format
- Pattern: `/^[a-z0-9-]+$/`
- Used in filename for safety

## Security Considerations

### Input Validation
- File type checked via MIME type
- File size enforced
- Filename sanitized (only slug + timestamp used)

### Path Traversal Prevention
- Filenames generated by backend (no user input)
- Files saved only in designated directory

### URL Generation
- Base URL from environment variable
- Full path constructed server-side

## Error Handling

### Upload Errors
- File too large: `BadRequestException`
- Invalid file type: `BadRequestException`
- Template not found: `NotFoundException`
- Disk write error: Propagated as 500

### Cleanup Errors
- Old file not found: Logged as warning, continues
- Delete permission error: Logged as warning, continues
- Safe failure: App continues even if cleanup fails

## Testing

### Manual Test Flow
1. Create template without thumbnail
2. Edit template, upload thumbnail → Check file created
3. Edit again, change thumbnail → Check old file deleted
4. Delete template → Check file deleted

### Sample Data
- Location: `.box-testing/json/templates-sample.json`
- Import script: `server/scripts/import-from-box-testing.ts`
- Includes 13 templates with various states

## Troubleshooting

### Thumbnail not displaying
- Check file exists: `ls server/public/thumbnails/`
- Check URL in database matches file
- Check static file serving configured
- Verify `process.cwd()` points to server root

### File not deleted
- Check logs for delete errors
- Verify file permissions
- Check URL parsing (must be valid URL)

### Upload fails
- Check disk space
- Verify directory exists and writable
- Check file size under 5MB
- Verify MIME type is allowed

## Future Enhancements

### Planned Features
- Multiple asset types (preview, cover, banner)
- Image optimization (resize, compress)
- CDN integration
- S3/cloud storage support
- Asset versioning in separate table

### Database Schema (Future)
```prisma
model TemplateAsset {
  id         String    @id @default(uuid())
  templateId String
  kind       AssetKind
  url        String
  sortOrder  Int       @default(0)
  createdAt  DateTime  @default(now())
  
  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@map("template_assets")
}
```

## References

- Backend: `server/src/templates/templates.service.ts` (uploadAsset method)
- Controller: `server/src/templates/templates-admin.controller.ts`
- Frontend: `web-cms/src/components/templates/TemplateFormDialog.tsx`
- API types: `web-cms/src/types/template.ts`

