# Context

Last updated: 2025-10-26

Current work focus
- **iOS Login Screen Redesign:** ✅ COMPLETED - Liquid Glass Beige authentication experience
  - Redesigned AuthLandingView with premium glass aesthetic matching Home screen
  - Implemented animated beige gradient background with organic blob motion
  - Created reusable glass components for authentication flow
  - Full documentation and implementation plans delivered
- **Templates API Integration (iOS ↔ Backend):** ✅ COMPLETED with 100% test coverage
  - Backend security fixes and enhancements implemented
  - iOS app fully integrated with real API data
  - Comprehensive unit tests: 85 total (38 backend + 47 iOS) - all passing
- **Web CMS Professional Redesign:** Completed comprehensive UI/UX redesign with Material-UI v7, professional theme, and modern components.
- **Template Detail Page:** Implemented full template detail view with AI image generation testing capabilities.
- Admin CRUD endpoints fully implemented and tested.
- Web CMS fully functional with templates management, testing, and professional interface.
- File upload system working with thumbnail management and automatic cleanup.
- Local development setup optimized (DB in Docker, server and web-cms run locally).

Recent changes (latest first)
- ✅ **Trending Templates API & iOS Home Screen Simplification (2025-10-26):**
  - **Implemented `/v1/templates/trending` endpoint:**
    - Backend: Added `listTrendingTemplates()` in TemplatesService (usage_count >= 500, sorted DESC)
    - Backend: Added `GET /v1/templates/trending` route in TemplatesController
    - iOS: Added `listTrendingTemplates()` to TemplatesRepository protocol
    - iOS: Updated HomeViewModel with `fetchTrendingFromAPI()` method
    - Updated OpenAPI/Swagger spec with complete endpoint documentation
    - Created .implementation_plan/trending-templates-api-plan.md
  - **Simplified Home Screen (MVP Design):**
    - Removed: Search, filters, categories, featured carousel, recent results
    - New user experience: Only "Trending Templates" with "See All" button
    - Existing user experience: User projects list + condensed trending list
    - Created AllTemplatesView for full templates with search/filters
    - Created SimpleHeader component (avatar + greeting + settings only)
    - Created Project model for future user projects feature
  - **Fixed Critical Image Loading Bug:**
    - **Root cause:** JSONDecoder's `.convertFromSnakeCase` strategy converted `thumbnail_url` → `thumbnailUrl` (lowercase "u"), but property was `thumbnailURL` (uppercase "URL")
    - **Solution:** Created custom JSONDecoder in TemplatesRepository that respects explicit CodingKeys (no auto snake_case)
    - **Impact:** All thumbnail images now load correctly from backend
  - **UI Improvements:**
    - Removed blur effect from CardGlassSmall (images now display sharp and clear)
    - Added gradient overlay on card bottoms for better text readability
    - Increased card height (180→200pt), improved spacing (12→14pt)
    - Added template count display, empty state, better "See All" button styling
    - Added debug logs for image loading and DTO decoding
  - **Files Updated:**
    - Backend: `templates.controller.ts`, `templates.service.ts`
    - iOS: `TemplatesHomeView.swift`, `HomeViewModel.swift`, `TemplatesRepository.swift`, `TemplatesDTOs.swift`, `GlassComponents.swift`, `AppConfig.swift`
    - New: `SimpleHeader.swift`, `AllTemplatesView.swift`, `Project.swift`
    - Documentation: `swagger/openapi.yaml`, `architecture.md`, `trending-templates-api-plan.md`
    - Guides: `SIMULATOR_NETWORK_FIX.md` (iOS Simulator cannot access localhost - must use Mac IP)
  - **Status:** Fully implemented, tested with debug logs, ready for user verification

- ✅ **iOS Login Screen Redesign (2025-10-26):**
  - **Design & Implementation:**
    - Created AuthLandingView.v2.swift with Liquid Glass Beige aesthetic
    - Implemented AuthBackgroundView with animated beige gradient + 2 organic blobs (13s & 15s cycles)
    - Built BrandLogoView with glass circle, gradient icon, and scale animation
    - Created AuthGlassCard reusable container with beige tint overlay and white border glow
    - Implemented GlassSignInButton with press states, haptic feedback, and smooth animations
    - Built LoadingGlassOverlay with blur effect for loading state
    - Created ErrorGlassBanner with slide animation and auto-dismiss
  - **Design System:**
    - Matches Liquid Glass Beige theme from Home screen (GlassTokens)
    - Colors: Warm Linen (#F5E6D3), Champagne (#F4E4C1), Dusty Rose (#E8D5D0), Dark Brown text (#4A3F35)
    - Premium glass effects: .ultraThinMaterial, gradient overlays, white border glow, soft shadows
    - Smooth animations: Logo scale (0.8→1.0), card slide-up, button press (1.0→0.98), blob motion
  - **Components Created:**
    - AuthLandingViewV2: Main view with animated background, logo, glass card, sign-in buttons
    - BrandLogoView: 100x100 glass circle with gradient sparkles icon
    - AuthGlassCard: Reusable glass container with 28pt corner radius, beige tint, white border
    - GlassSignInButton: 56pt height buttons with press animations and haptic feedback
    - LoadingGlassOverlay: Full-screen blur with glass HUD and progress indicator
    - ErrorGlassBanner: Red glass banner with slide-in/out animations
  - **Integration:**
    - Updated BootstrapViews.swift to use AuthLandingViewV2 (line 42)
    - No changes required to AuthViewModel (backward compatible)
    - Works with existing Firebase Auth flow (Google & Apple Sign In)
  - **Documentation:**
    - Created .implementation_plan/login-redesign-plan.md (comprehensive design plan)
    - Created .implementation_plan/login-mockup.md (visual mockup with specs)
    - Created .implementation_plan/LOGIN_REDESIGN_SUMMARY.md (implementation guide)
  - **User Feedback:** Approved by user ("look good")
  - **Status:** Production-ready, deployed to app

- ✅ **Templates API Integration & Testing (2025-10-26):**
  - **Backend Security & Enhancements:**
    - Added security filters to `/v1/templates`: only return published + public templates
    - Implemented tags filtering with `hasSome` Prisma query
    - Added comprehensive mapping from `DbTemplate` to `ApiTemplate` with snake_case
    - Created `TemplatesRepositoryProtocol` for iOS testability
  - **iOS DTOs & ViewModels:**
    - Updated `TemplateDTO` with `publishedAt` and `usageCount` fields
    - Added computed properties `isNew` (published within 7 days) and `isTrending` (usage >= 100)
    - Updated `HomeViewModel.fetchFromAPI()` to use real API via repository protocol
    - Dynamic subtitle/tag generation based on template data (New, Popular, uses count)
    - Featured templates now prioritize trending/new items (max 3)
    - Updated `GlassComponents` (CardGlassSmall, CardGlassLarge) with `AsyncImage` for real thumbnails
  - **Comprehensive Test Coverage (100% pass rate):**
    - **Backend Unit Tests (23):** TemplatesService security, search, tags, sorting, pagination, mapping
    - **Backend E2E Tests (15):** `/v1/templates` endpoint with query params, response format validation
    - **iOS Unit Tests (47):**
      - TemplateDTO: decoding, computed properties (isNew/isTrending), Hashable, Identifiable
      - HomeViewModel: initialization, fetchFromAPI, template mapping, filtering, search, favorites, featured logic
    - Fixed async timing issues in iOS tests (increased sleep to 100ms)
    - All 85 tests passing successfully
  - **Files Updated:**
    - Backend: `templates.service.ts`, `templates.service.spec.ts`, `templates.e2e-spec.ts`
    - iOS: `TemplatesDTOs.swift`, `TemplatesRepository.swift`, `HomeViewModel.swift`, `GlassComponents.swift`
    - iOS Tests: `TemplateDTOsTests.swift`, `HomeViewModelTests.swift`, `MockTemplatesRepository`


- ✅ **Web CMS Template Detail Page (2025-10-26):**
  - Implemented comprehensive Template Detail page with 2-column layout
  - Created TemplateInfoCard: displays full template info with accordions for prompts and metadata
  - Created ImageGeneratorForm: dual-mode (upload file / paste URL) with validation and preview
  - Created ResultDisplay: side-by-side comparison of original and processed images
  - Integrated with image processing API (/v1/images/process)
  - Added loading states, error handling, and user feedback (snackbars)
  - Full TypeScript typing with proper API client integration
  - Build successful, production-ready
- ✅ **Web CMS UI/UX Professional Redesign (2025-10-26):**
  - Created professional theme: Indigo primary (#3f51b5) + Teal secondary (#009688), Inter font
  - Built AppLayout component: navigation bar with logo, menu, user dropdown
  - Enhanced TemplateFormDialog: tabbed interface (Basic Info, AI Prompts, Media, Settings) with character counters
  - Redesigned TemplateTable: modern design with hover effects, color-coded chips, larger thumbnails
  - Created Dashboard page: stats cards and recent templates list
  - Built utility components: LoadingState, EmptyState for consistent UX
  - Updated filters with responsive flexbox layout
  - All components follow Material-UI v7 patterns, clean code, no TypeScript errors
- ✅ **Phase 1 Prompt Fields Implementation (2025-10-26):**
  - Added prompt, negativePrompt, modelProvider, modelName fields to Template model
  - Updated Prisma schema with new fields and migration (20251026115941_add_prompt_fields)
  - Updated all DTOs (CreateTemplateDto, UpdateTemplateDto) and service layer
  - Updated Web CMS types and UI to support new fields
  - Updated sample data with realistic prompts for all 13 templates
  - Successfully re-imported sample data with new fields
- ✅ **iOS Profile Screen (2025-10-26):**
  - Completed full profile screen with card-based layout matching Home design
  - Created ProfileComponents: HeroCard, StatCard, SettingsRow, SettingsToggleRow, DangerButton
  - Implemented ProfileView with sections: Hero, Stats, Account, Preferences, About, Danger Zone
  - Created ProfileEditView modal with form validation (name, email)
  - Integrated with CompactHeader settings button (fullscreen modal)
  - Added signOut() method to AuthViewModel
  - No linter errors, ready for testing
- ✅ **iOS UI Redesign (2025-10-26):**
  - Implemented beige + liquid glass minimalist design theme
  - Updated GlassTokens with warm beige color palette (#F5E6D3, #D4C4B0, #F4E4C1, #E8D5D0)
  - Reduced blur (25→15), shadow (25→18), and border thickness for minimalist aesthetic
  - Updated all text colors to dark brown (#4A3F35) for proper contrast on light background
  - Updated all components: GlassComponents, TemplatesHomeView, CompactHeader, HeroStatsCard, CategoryChip
  - No linter errors, ready for testing on simulator
- ✅ Completed admin CRUD endpoints (Phase 2):
  - GET /v1/admin/templates (list with full admin fields including slug, status, visibility, tags)
  - POST /v1/admin/templates (create template)
  - GET /v1/admin/templates/{slug} (get by slug)
  - PUT /v1/admin/templates/{slug} (update template)
  - DELETE /v1/admin/templates/{slug} (delete template with file cleanup)
  - POST /v1/admin/templates/{slug}/publish (publish with thumbnail validation)
  - POST /v1/admin/templates/{slug}/unpublish (unpublish)
  - POST /v1/admin/templates/{slug}/assets (upload thumbnail with multer)
- Prisma schema updated with full template fields:
  - Added slug (unique), description, status (enum), visibility (enum), tags (array), createdAt, updatedAt
  - Migration applied: 20251026105027_add_admin_fields_to_templates
- Static file serving configured with ServeStaticModule (process.cwd()/public)
- File upload with automatic cleanup: old thumbnails deleted when uploading new ones, files deleted when template is deleted
- Web CMS UI complete: create, edit (with thumbnail change), delete, publish/unpublish all working
- Local dev setup: only DB in Docker, server (yarn start:dev) and web-cms run on host for better DX

Decisions and Key Learnings
- **CRITICAL:** iOS JSONDecoder with `.convertFromSnakeCase` + explicit CodingKeys = CONFLICT!
  - Problem: `.convertFromSnakeCase` converts `thumbnail_url` → `thumbnailUrl` (lowercase "u")
  - Our property: `thumbnailURL` (uppercase "URL") per Swift conventions
  - Solution: Use custom JSONDecoder WITHOUT `.convertFromSnakeCase`, rely on explicit CodingKeys
  - Always use explicit CodingKeys in DTOs for backend API (snake_case → camelCase mapping)
- **iOS Simulator Network:** Cannot access host's `localhost` - must use Mac's IP address (e.g., 192.168.1.123:8080)
  - Update AppConfig.swift with Mac IP for testing
  - Backend must listen on 0.0.0.0 (all interfaces), not just localhost
- Web CMS uses Material-UI v7 with custom professional theme (Indigo + Teal, Inter font)
- Template prompts stored directly in Template model (Phase 1), will move to template_versions later (Phase 2)
- Image processing uses synchronous API for Phase 1, will add async job queue later
- Web CMS Template Detail page uses 2-column layout (info + generator) for better UX
- Use multer (@nestjs/platform-express) for file upload handling
- Store uploaded files in public/thumbnails/ with pattern: {slug}-{kind}-{timestamp}.{ext}
- Auto-delete old files when uploading new thumbnails or deleting templates (disk cleanup)
- Use process.cwd() for static file path to work in both dev and prod
- Admin endpoints use full TemplateAdmin type with all fields, public endpoints use minimal Template type
- Run server and web-cms locally for hot-reload, only DB in Docker
- **Testing:**
  - Backend: Use Jest for unit tests, Supertest for e2e, mock PrismaService for isolation
  - iOS: Use Swift Testing framework (@Test, @Suite), mock repositories via protocols
  - iOS async tests require 100ms sleep for Task completion (unstructured Task in ViewModel)
  - Disable parallel testing on iOS (`-parallel-testing-enabled NO`) for deterministic results

Next steps
- **iOS Integration Testing:** Test real API integration with Firebase auth on simulator/device
- **End-to-End iOS Tests:** Implement UI tests for template browsing and favorites flow
- **Test Template Detail page with real backend API** (image processing endpoint)
- **Implement async job queue for image processing** (polling every 2s)
- Implement file upload endpoint (/v1/images/upload) for image generator
- Add test history storage and display
- Implement template_versions table for prompt management (Phase 2)
- Add template_assets table for multiple asset types (preview, cover)
- Add E2E tests for Web CMS
- Deploy backend and configure production Firebase credentials

References
- **iOS Login Screen Redesign:**
  - .implementation_plan/login-redesign-plan.md → Comprehensive design plan with phases and components
  - .implementation_plan/login-mockup.md → Visual mockup with color specs, animations, accessibility
  - .implementation_plan/LOGIN_REDESIGN_SUMMARY.md → Implementation guide and testing checklist
  - AIPhotoApp/AIPhotoApp/Views/Authentication/AuthLandingView.v2.swift → New login screen implementation
  - AIPhotoApp/AIPhotoApp/Views/Common/BootstrapViews.swift → Router integration (line 42)
- **API Integration & Testing:**
  - server/src/templates/templates.service.ts → Security filters, tags, mapping logic
  - server/src/templates/templates.service.spec.ts → 23 unit tests for service layer
  - server/test/templates.e2e-spec.ts → 15 e2e tests for /v1/templates endpoint
  - AIPhotoApp/AIPhotoApp/Models/DTOs/TemplatesDTOs.swift → iOS DTOs with computed properties
  - AIPhotoApp/AIPhotoApp/Repositories/TemplatesRepository.swift → iOS API client with protocol
  - AIPhotoApp/AIPhotoApp/ViewModels/HomeViewModel.swift → Real API integration logic
  - AIPhotoApp/AIPhotoAppTests/TemplateDTOsTests.swift → 20 iOS DTO tests
  - AIPhotoApp/AIPhotoAppTests/HomeViewModelTests.swift → 27 iOS ViewModel tests
- **Web CMS:**
  - .implementation_plan/ui-ux-redesign-summary.md → Web CMS UI/UX redesign complete details
  - .implementation_plan/template-detail-page-summary.md → Template Detail page implementation
  - .implementation_plan/phase1-prompt-fields-implementation-summary.md → Prompt fields Phase 1
  - web-cms/src/theme/theme.ts → Professional theme configuration
  - web-cms/src/components/layout/AppLayout.tsx → Main layout with navigation
  - web-cms/src/components/templates/TemplateDetailPage.tsx → Template detail with generator
  - web-cms/src/api/images.ts → Image processing API client
- **iOS UI:**
  - .implementation_plan/profile-screen-design.md → iOS Profile screen plan
  - .implementation_plan/ui-redesign-beige-minimalist.md → iOS UI redesign plan
  - AIPhotoApp/AIPhotoApp/Views/Common/GlassComponents.swift → Liquid glass UI components
- **Backend:**
  - server/src/templates/templates-admin.controller.ts → Admin CRUD endpoints
  - .box-testing/json/templates-sample.json → Sample data with prompts (13 templates)
  - server/scripts/import-from-box-testing.ts → Script to import sample data
