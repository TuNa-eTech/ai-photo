# Architecture

Last updated: 2025-11-17

System overview
- iOS app (SwiftUI) consumes public APIs for browsing templates and processing images.
  - Uses Repository Protocol pattern for testability (TemplatesRepositoryProtocol).
  - ViewModels use @Observable for reactive state management.
  - Implements liquid glass beige minimalist UI design.
- Web CMS (Vite + React + TS + Material-UI v7) for admins to manage templates and test image generation.
  - Professional UI with custom theme (Indigo + Teal), Inter font, responsive layout.
  - Features: Dashboard, Templates List, Template Detail with Image Generator, Create/Edit forms, Trending Management.
  - **Trending System**: Manual trending control with visual badges, advanced filtering, and toggle functionality.
- Backend (NestJS + Prisma) exposes:
  - Public endpoints (templates listing with security filters: published + public only).
  - Admin endpoints (templates CRUD, assets, publish/unpublish).
  - Envelope response format with standardized error handling.
- PostgreSQL stores templates with prompts, tags, metadata, and usage statistics.
- Local dev uses Docker Compose for Postgres and NestJS runtime container. DevAuth can be enabled for admin endpoints in local.
- Comprehensive test coverage: 85 tests (38 backend + 47 iOS) with 100% pass rate.

Key code paths (backend)
- Entrypoint:
  - server/src/main.ts (NestJS bootstrap with global interceptors, filters, CORS).
- HTTP layer:
  - server/src/app.module.ts (root module configuration).
  - server/src/templates/templates.controller.ts (Public templates listing, trending, categories).
  - server/src/templates/templates-admin.controller.ts (Admin templates CRUD, trending management endpoints).
  - server/src/templates/templates.service.ts (business logic with security filters, category management, category-to-tags mapping, trending status management, camelCase field transformation).
  - server/src/templates/dto/ (request/response DTOs with validation, category DTOs).
- **Image Processing:**
  - server/src/gemini/gemini.module.ts (Gemini API integration module).
  - server/src/gemini/gemini.service.ts (Call Gemini API, parse responses, handle timeouts).
  - server/src/gemini/exceptions/ (GeminiAPIException, ContentPolicyException).
  - server/src/images/images.module.ts (Image processing module).
  - server/src/images/images.controller.ts (POST /v1/images/process with 60s timeout).
  - server/src/images/images.service.ts (Business logic with mock mode support via USE_MOCK_IMAGE env flag, enforces credit deduction).
  - server/src/images/dto/ (ProcessImageDto, ProcessImageResponse).
  - Mock mode: When `USE_MOCK_IMAGE=true`, returns `mock_dev/test_img.png` instead of calling GeminiService (cost-saving for development).
- **Credits & IAP:**
  - server/src/credits/credits.module.ts (Credits management module).
  - server/src/credits/credits.service.ts (Balance, deduct, add, history operations).
  - server/src/credits/credits.controller.ts (GET /v1/credits/balance, GET /v1/credits/transactions, POST /v1/credits/purchase).
  - server/src/iap/iap.module.ts (IAP processing module).
  - server/src/iap/iap.service.ts (StoreKit 2 JWT/JSON verification, purchase processing with idempotency).
  - server/src/iap/iap.controller.ts (GET /v1/iap/products - public endpoint).
  - Transaction verification: Supports JWT (iOS 15-17) and JSON (iOS 26+) formats from StoreKit 2.
  - Idempotency: Uses `original_transaction_id` to prevent duplicate credit awards.
- Auth:
  - server/src/auth/bearer-auth.guard.ts (Firebase token verification + DevAuth).
  - server/src/auth/firebase-admin.ts (Firebase Admin SDK initialization).
- Data access:
  - server/src/prisma/prisma.service.ts (Prisma client service).
  - server/prisma/schema.prisma (database schema definition).
  - server/prisma/migrations/ (database migrations).
- Common:
  - server/src/common/interceptors/envelope.interceptor.ts (response envelope wrapper).
  - server/src/common/filters/http-exception.filter.ts (error envelope mapping).
  - server/src/common/dto/envelope.dto.ts (envelope types and helpers).
- Testing:
  - server/src/templates/templates.service.spec.ts (23 unit tests with mocked Prisma).
  - server/test/templates.e2e-spec.ts (15 e2e tests with DevAuth).
  - server/src/gemini/gemini.service.spec.ts (NEW - Gemini service tests).
  - server/src/images/images.controller.spec.ts (NEW - Images controller tests).
  - server/test/images.e2e-spec.ts (NEW - Images E2E tests).

Database schema (PostgreSQL)
- Tables (see server/prisma/schema.prisma):
  - templates (id UUID, slug String unique, name String, description String, prompt String, negativePrompt String, modelProvider String, modelName String, status enum, visibility enum, thumbnailUrl String, publishedAt DateTime, usageCount Int, tags String[], createdAt DateTime, updatedAt DateTime).
  - users (id UUID, firebaseUid String unique, name String, email String, avatarUrl String, credits Int default 2, createdAt DateTime, updatedAt DateTime).
  - transactions (id UUID, userId UUID FK, type enum, amount Int, productId String, appleTransactionId String, appleOriginalTransactionId String, transactionData String, status enum, createdAt DateTime, updatedAt DateTime).
  - iap_products (id UUID, productId String unique, name String, description String, credits Int, price Decimal, currency String, isActive Boolean, displayOrder Int, createdAt DateTime, updatedAt DateTime).
  - Enums: TemplateStatus (draft, published, archived), TemplateVisibility (public, private), TransactionType (purchase, usage, bonus), TransactionStatus (pending, completed, failed, refunded).
  - Future: template_versions, template_assets (to be added for prompt management and multiple assets).
- Migrations:
  - Prisma migrations in server/prisma/migrations/
  - Latest: 20251109190005_add_credits_and_iap_system (added credits, transactions, iap_products)
  - Previous: 20251026115941_add_prompt_fields (added prompt, negativePrompt, modelProvider, modelName)
  - Previous: 20251026105027_add_admin_fields_to_templates (added admin fields)
  - Schema defined in Prisma format with @map directives for PostgreSQL compatibility.

Local development patterns
- Preferred E2E path: Dockerized NestJS container connects to DB via Docker network:
  - DATABASE_URL=postgres://imageai:imageai_pass@db:5432/imageai_db?sslmode=disable.
  - Admin auth via DevAuth (DEV_AUTH_ENABLED=1) → use DEV_AUTH_TOKEN for Authorization: Bearer <token>.
- Host-run NestJS (yarn start:dev) can be used with host Postgres connection.

Admin Templates flow (implemented)
- Public endpoints:
  - GET /v1/templates → TemplatesService.listTemplates (minimal fields for end users, all templates with filters: q, tags, category, sort)
  - GET /v1/templates/trending → TemplatesService.listTrendingTemplates (high usage templates with usage_count >= 500, sorted DESC)
  - GET /v1/templates/categories → TemplatesService.listCategories (returns predefined categories: portrait, landscape, artistic, vintage, abstract)
- Admin endpoints (templates-admin.controller.ts):
  - GET /v1/admin/templates → listAdminTemplates (full fields including slug, status, visibility, tags)
  - POST /v1/admin/templates → createTemplate (with validation: slug format, unique check)
  - GET /v1/admin/templates/{slug} → getTemplateBySlug
  - PUT /v1/admin/templates/{slug} → updateTemplate (cannot change slug)
  - DELETE /v1/admin/templates/{slug} → deleteTemplate (with file cleanup)
  - POST /v1/admin/templates/{slug}/publish → publishTemplate (validates thumbnail_url exists)
  - POST /v1/admin/templates/{slug}/unpublish → unpublishTemplate
  - POST /v1/admin/templates/{slug}/assets → uploadAsset (multer file upload, auto-cleanup old files)
- File handling:
  - Uploads saved to public/thumbnails/ with pattern: {slug}-{kind}-{timestamp}.{ext}
  - Old thumbnail deleted automatically when uploading new one
  - All files deleted when template is deleted
  - Static files served via ServeStaticModule at /public/*

Observability (dev)
- NestJS built-in logging with request/response tracking.
- Global exception filter maps HTTP exceptions to envelope errors.
- Envelope interceptor wraps all successful responses.
- Prisma query logging available in development mode.

Containers
- docker/docker-compose.yml:
  - services:
    - db (postgres:15) exposed on host 5432 with persistent volume.
    - server (NestJS runtime image, port 8080) with envs for DB and DevAuth.
    - web_cms and web_cms_preview (optional dev HMR/preview).
    - pgadmin (optional).
- server/Dockerfile (Node.js + NestJS build process).

Web CMS architecture (web-cms/)
- Built with Vite + React 19 + TypeScript + Material-UI v7
- Project structure:
  - src/api/ → API client layer (axios-based with envelope unwrapping)
    - client.ts → Base API client with auth interceptor
    - templates.ts → Templates API functions
    - images.ts → Image processing API functions
    - credits.ts → (NEW) Credits and IAP API functions (balance, transactions, purchase, IAP products)
  - src/components/ → Reusable UI components
    - common/ → LoadingState, EmptyState
    - dashboard/ → StatsCard
    - layout/ → AppLayout (navigation, header, user menu)
    - templates/ → TemplateTable, TemplateFormDialog, TemplateInfoCard, ImageGeneratorForm, ResultDisplay, TemplatesFilters
  - src/pages/ → Page-level components
    - Dashboard/DashboardPage.tsx → Stats and recent templates
    - Templates/TemplatesListPage.tsx → Templates list with CRUD
    - Templates/TemplateDetailPage.tsx → Template detail with image generator
    - IAP/IAPProductsPage.tsx → (NEW) IAP products list view
    - Transactions/TransactionsPage.tsx → (NEW) Transaction history with filters and search
    - Login/LoginPage.tsx → Firebase auth login
  - src/theme/theme.ts → Custom Material-UI theme (Indigo + Teal, Inter font)
  - src/types/ → TypeScript type definitions (TemplateAdmin, CreateTemplateRequest, etc.)
  - src/auth/ → Firebase auth context and hooks
  - src/router/routes.tsx → React Router v6 configuration
- Key features:
  - Dashboard with stats cards and recent templates list
  - Templates list with filters, search, pagination
  - Template detail page with 2-column layout (info + generator)
  - Image generator with dual input mode (file upload / URL paste)
  - Side-by-side result comparison
  - Create/Edit template dialog with tabbed interface (Basic, AI Prompts, Media, Settings)
  - Professional theme with consistent spacing, colors, typography
  - Responsive design (mobile-friendly)
  - Loading states, error handling, user feedback (snackbars)

iOS app architecture (AIPhotoApp/)
- **Architecture Pattern: MVVM + Repository + Service Layer**
  - View → ViewModel → Repository → Service → Network
  - ViewModels use `@Observable` macro (Swift Observation framework)
  - Repositories are protocol-based for testability
  - Services are protocol-based when needed for testing
  - Dependency injection via constructor with default parameters
  - Shared state via `@Environment` (no prop drilling)
- Built with SwiftUI + Firebase SDK
- Project structure:
  - Models/DTOs/ → Data transfer objects matching backend API schema
    - TemplatesDTOs.swift → TemplateDTO with computed properties (isNew, isTrending)
    - AuthDTOs.swift → UserRegisterRequest/Response for backend registration
    - ProcessImageRequest.swift → (NEW) Image processing request DTO
    - ProcessImageResponse.swift → (NEW) Image processing response DTO
    - Project.swift → (NEW) Local project model for "My Projects"
  - Repositories/ → API client layer with protocol-based architecture
    - TemplatesRepository.swift → Implements TemplatesRepositoryProtocol for testability, supports query parameter for search, category parameter for filtering, listCategories for fetching categories
    - UserRepository.swift → User registration API with envelope handling
    - ImageProcessingAPIClient.swift → (NEW) Image processing API client with 60s timeout
    - ProjectsStorageManager.swift → (NEW) Local project storage (save/load/delete projects)
    - CreditsRepository.swift → (NEW) Credits and IAP API client (balance, transactions, purchase, IAP products)
  - Services/ → Business services (protocol-based for testability)
    - AuthService.swift → Firebase authentication service
    - BackgroundImageProcessor.swift → (NEW) Background URLSession processor with BackgroundImageProcessorProtocol
    - InAppPurchaseService.swift → (NEW) StoreKit 2 integration for consumable IAP products, returns JSON transaction data (iOS 26+)
  - ViewModels/ → Observable view models for business logic
    - HomeViewModel.swift → Manages template state, fetching, filtering, favorites, supports query parameter for search, category parameter for filtering. Injects TemplatesRepositoryProtocol via constructor.
    - AuthViewModel.swift → Firebase authentication and user registration. Provided globally via @Environment.
    - ImageProcessingViewModel.swift → (NEW) Handles image processing flow with background support. Injects BackgroundImageProcessorProtocol via constructor.
    - CreditsViewModel.swift → (NEW) Manages credits balance, IAP products, purchase flow. Loads products from StoreKit + server for credits mapping. Posts .creditsBalanceUpdated notification.
  - Views/ → SwiftUI views with liquid glass design
    - Common/ → Reusable components and navigation
      - MainTabView.swift → (NEW) Tab-based navigation with 4 tabs (Home, Projects, Profile, Search), uses Tab(value:role:) wrapper
      - GlassComponents.swift → Glass design components (GlassTokens, GlassCardModifier, GlassChip, etc.)
      - GlassBackgroundView.swift → Animated beige gradient background
      - BootstrapViews.swift → Root router (Splash → Login → MainTabView)
    - Home/ → Template browsing
      - HomeView.swift → (Renamed from TemplatesHomeView) Simplified MVP home with trending templates
      - SimpleHeader.swift → Minimal header (avatar + greeting + settings)
      - AllTemplatesView.swift → Full templates list with `.searchable()` modifier, category filters (from CategoryManager), and filter segments (API sort)
    - Search/ → (NEW) Search functionality
      - SearchView.swift → Dedicated search view with `.searchable(placement: .navigationBarDrawer)`, debouncing, API integration, category filters (from CategoryManager), inline navigation title, horizontal scrolling categories
    - ImageProcessing/ → (NEW) Image processing UI
      - ImageProcessingView.swift → Processing screen with progress and states
      - ResultView.swift → (Renamed from ProcessingResultView) Before/after comparison view
      - TemplateSelectionView.swift → Template selection and image picker
    - Projects/ → (NEW) User projects
      - MyProjectsView.swift → Grid view of user's processed images
    - Authentication/ → Login/signup flows
      - AuthLandingView.v2.swift → Premium login screen with Liquid Glass Beige design
      - ProfileCompletionView.swift → Profile editing modal
      - Components/ → Authentication-specific components
    - Home/ProfileView.swift → User profile and settings (part of tab navigation)
  - Utilities/ → Shared utilities
    - Networking/ → APIClient with envelope handling and 401 retry
    - Constants/ → Design tokens (GlassTokens with beige color palette), API paths (AppConfig)
    - Helpers/ → CategoryManager.swift → Manages categories loaded from API with UI metadata mapping (icons), fallback categories
    - BackgroundImageProcessor.swift → (NEW) Background URLSession processor for long-running requests
    - Extensions/UIImage+Compression.swift → (NEW) Image compression utilities
- Testing:
  - AIPhotoAppTests/TemplateDTOsTests.swift → 20 tests for DTO decoding and computed properties
  - AIPhotoAppTests/HomeViewModelTests.swift → 27 tests for ViewModel logic and API integration
  - AIPhotoAppTests/ImageProcessingViewModelTests.swift → (NEW) Image processing ViewModel tests
  - AIPhotoAppTests/ProjectsStorageManagerTests.swift → (NEW) Storage manager tests
  - Uses MockTemplatesRepository conforming to TemplatesRepositoryProtocol for isolated testing
- Key patterns:
  - **MVVM + Repository + Service Layer Architecture:**
    - ViewModels inject dependencies via constructor (e.g., `init(repository: TemplatesRepositoryProtocol = TemplatesRepository())`)
    - Repositories are protocol-based for easy mocking in tests
    - Services are protocol-based when needed (e.g., `BackgroundImageProcessorProtocol`)
    - No hard-coded dependencies in Views or ViewModels
  - **State Management:**
    - `@Environment` for app-wide shared state (AuthViewModel provided at app root)
    - `@State` for local ViewModels and UI state
    - No prop drilling - use `@Environment` instead of passing through many layers
  - **Dependency Injection:**
    - Constructor injection with default parameters for convenience
    - Protocol-based dependencies for testability
    - No direct singleton access - inject via protocol
  - **Repository Protocol pattern for dependency injection and testability**
  - @Observable for reactive ViewModels (no @Published/@StateObject needed)
  - APIClient with envelope unwrapping and standardized error handling
  - Custom JSONDecoder without `.convertFromSnakeCase` to respect explicit CodingKeys
  - AsyncImage for loading thumbnails from URLs with fallback SF Symbols
  - Dynamic subtitle/tag generation based on template metadata
  - Reusable glass components for consistent UI across authentication and main app
  - Tab-based navigation using `Tab(value:role:)` wrapper (SwiftUI best practice)
  - Native `.searchable()` modifier for search functionality (replaces custom search bars)
  - `.tabBarMinimizeBehavior(.onScrollDown)` for automatic tab bar hiding
  - Error handling with categorized messages and retry actions
  - Empty states with glass effects, icons, and action buttons
- Navigation Structure:
  - MainTabView: Root navigation with 4 tabs using `Tab(value:role:)` wrapper
    - Home Tab: HomeView with trending templates
    - Projects Tab: MyProjectsView with user's processed images
    - Profile Tab: ProfileView with user settings
    - Search Tab: SearchView with `role: .search` for proper tab bar placement
  - Tab Bar Features:
    - `.tabBarMinimizeBehavior(.onScrollDown)` - Auto-hide when scrolling down
    - Custom appearance with glass effects and beige color scheme
    - Selected tab: Dark brown (GlassTokens.textPrimary) for better contrast
    - Unselected tab: Soft brown (GlassTokens.textSecondary)
- MVP Home Screen UX:
  - Simplified design focused on trending templates
  - New users: Only "Trending Templates" section with "See All" button
  - Existing users: "My Projects" history + condensed trending list (6 items)
  - Clear template thumbnails with gradient overlay for text readability
  - Card height: 200pt, spacing: 14pt for breathable layout
  - SimpleHeader: Avatar + greeting + settings (no search/filters on home)
  - AllTemplatesView: Full templates with `.searchable()` modifier, category filters, and filter segments
- Search Experience:
  - SearchView: Dedicated search tab with full functionality
    - `.searchable(placement: .navigationBarDrawer(displayMode: .always))` for native search
    - Debouncing (0.5s delay) to reduce API calls
    - Category filters loaded from API via CategoryManager (horizontal scrolling)
    - Filter segments (Trending/New) use API `sort` parameter
    - Inline navigation title with custom font size (20pt, semibold)
    - Empty state and loading state
    - All filtering done server-side (no client-side filtering)
  - AllTemplatesView: Also uses `.searchable()` for consistent experience, category filters from CategoryManager
  - API Integration: TemplatesRepository supports `query` parameter for server-side search, `category` parameter for filtering
  - Category Management: CategoryManager loads categories from `/v1/templates/categories`, maps to UI with icons, fallback to local categories if API fails
- Authentication UI (AuthLandingView.v2):
  - Animated beige gradient background with 2 organic blobs (13s & 15s motion cycles)
  - BrandLogoView: Glass circle (100x100) with gradient sparkles icon and scale animation
  - AuthGlassCard: Reusable glass container with beige tint overlay and white border glow
  - GlassSignInButton: 56pt height buttons with press states, haptic feedback, smooth animations
  - LoadingGlassOverlay: Full-screen blur with glass HUD for loading state
  - ErrorGlassBanner: Red glass banner with slide-in/out animations and auto-dismiss
  - Integrated with BootstrapViews router for seamless flow (Splash → Login → Home)

References
- **iOS Navigation & Search:**
  - AIPhotoApp/AIPhotoApp/Views/Common/MainTabView.swift → Tab-based navigation with Tab(value:role:) wrapper
  - AIPhotoApp/AIPhotoApp/Views/Search/SearchView.swift → Dedicated search view with .searchable() modifier
  - AIPhotoApp/AIPhotoApp/Views/Home/AllTemplatesView.swift → Full templates with .searchable() modifier
  - AIPhotoApp/AIPhotoApp/Repositories/TemplatesRepository.swift → API client with query parameter support
- **iOS Error Handling:**
  - .documents/platform-guides/ios-error-handling.md → Comprehensive error handling and empty state guide
  - AIPhotoApp/AIPhotoApp/ViewModels/HomeViewModel.swift → Error categorization and handling logic
  - AIPhotoApp/AIPhotoApp/Views/Home/HomeView.swift → Error banner and empty state UI
- **iOS Authentication:**
  - .implementation_plan/login-redesign-plan.md → Login screen redesign plan
  - .implementation_plan/login-mockup.md → Visual mockup with specs
  - .implementation_plan/LOGIN_REDESIGN_SUMMARY.md → Implementation guide
  - AIPhotoApp/AIPhotoApp/Views/Authentication/AuthLandingView.v2.swift → New login implementation
- **iOS Home Screen:**
  - .implementation_plan/trending-templates-api-plan.md → Trending API implementation plan
  - SIMULATOR_NETWORK_FIX.md → iOS Simulator network troubleshooting guide
  - AIPhotoApp/AIPhotoApp/Views/Home/HomeView.swift → (Renamed from TemplatesHomeView) Simplified MVP home
  - AIPhotoApp/AIPhotoApp/Views/Home/SimpleHeader.swift → Minimal header component
  - AIPhotoApp/AIPhotoApp/Models/DTOs/TemplatesDTOs.swift → Custom decoder implementation
- **Web CMS:**
  - .implementation_plan/ui-ux-redesign-summary.md → Web CMS redesign details
  - .implementation_plan/template-detail-page-summary.md → Template detail implementation
- **Backend:**
  - .documents/workflows/run-tests.md → Admin API E2E (Docker + DevAuth)
  - .documents/troubleshooting/db-auth.md → DB auth issues and fixes
  - server/src/templates/templates.service.ts → Prisma query details (includes listTrendingTemplates)
  - server/src/templates/templates.controller.ts → request handling and validation (includes trending route)
  - swagger/openapi.yaml → API specification (includes /v1/templates/trending)
  - .implementation_plan/nest-migration-plan.md → Migration from Go to NestJS
