
services:
  db:
    image: postgres:15
    container_name: imageaiwrapper-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: imageai
      POSTGRES_PASSWORD: imageai_pass
      POSTGRES_DB: imageai_db
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile.runtime
    container_name: imageaiwrapper-backend
    restart: unless-stopped
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: imageai
      DB_PASSWORD: imageai_pass
      DB_NAME: imageai_db
      TEMPLATE_SOURCE: db
      # CORS for web_admin dev (used by backend if CORS middleware reads these)
      CORS_ALLOWED_ORIGINS: http://localhost:5173
      CORS_ALLOWED_HEADERS: Authorization,Content-Type
      FIREBASE_SERVICE_ACCOUNT: /secrets/firebase-admin.json
      # Set a comma-separated list or use Firebase custom claim 'admin'
      ADMIN_EMAILS: ${ADMIN_EMAILS:-admin@example.com}
      # Dev-only toggle: expose admin endpoints without Firebase Admin (DO NOT USE IN PROD)
      ALLOW_INSECURE_ADMIN: "1"
      # Dev email/password auth (DEV only)
      DEV_AUTH_ENABLED: "1"
      DEV_ADMIN_EMAIL: ${DEV_ADMIN_EMAIL:-admin@example.com}
      DEV_ADMIN_PASSWORD: ${DEV_ADMIN_PASSWORD:-admin123}
      # Assets storage for uploads
      ASSETS_DIR: /assets
      ASSETS_BASE_URL: /assets
    ports:
      - "8080:8080"
    volumes:
      - ../backend/processed:/processed
      - ../backend/assets:/assets
      - ${FIREBASE_SA_PATH:-/absolute/path/to/firebase-admin.json}:/secrets/firebase-admin.json:ro
    depends_on:
      - db
    # Uncomment below to mount code for live reload with tools like air or reflex
    # volumes:
    #   - ../backend:/app

  # Optional: run web_admin in Docker for dev (Vite with HMR)
  # The app will be available at http://localhost:5173
  web:
    image: node:20-alpine
    container_name: imageaiwrapper-web
    working_dir: /app
    environment:
      CI: "true"
      # Vite reads from .env.local in the project root (mounted via volume). These can override if needed.
      VITE_API_BASE_URL: http://localhost:8080
      VITE_DEV_AUTH: "1"
    volumes:
      - ../web_admin:/app
      - /app/node_modules
    command: sh -c "corepack enable && corepack prepare pnpm@10.18.3 --activate || true; pnpm install --no-frozen-lockfile; pnpm dev --host 0.0.0.0"
    ports:
      - "5173:5173"
    depends_on:
      - backend

  pgadmin:
    image: dpage/pgadmin4
    container_name: imageaiwrapper-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@gmail.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - db

volumes:
  db_data:
