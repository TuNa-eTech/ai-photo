services:
  db:
    image: postgres:15
    container_name: imageaiwrapper-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: imageai
      POSTGRES_PASSWORD: imageai_pass
      POSTGRES_DB: imageai_db
    ports:
      - "55432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  server:
    build:
      context: ../server
      dockerfile: Dockerfile
    container_name: imageaiwrapper-server
    restart: unless-stopped
    environment:
      # Server runtime
      PORT: 8080
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:4173
      # Database for Prisma inside container (host = db)
      DATABASE_URL: postgresql://imageai:imageai_pass@db:5432/imageai_db?schema=public
      # DevAuth (local/dev) - disable in prod
      DEV_AUTH_ENABLED: "1"
      DEV_AUTH_TOKEN: "dev"
      # Firebase Admin (optional; used when DEV_AUTH_ENABLED=0)
      # FIREBASE_PROJECT_ID: ""
      # FIREBASE_CLIENT_EMAIL: ""
      # FIREBASE_PRIVATE_KEY: ""
    ports:
      - "8080:8080"
    volumes:
      # Mount public directory for static file serving (uploaded assets)
      - ../server/public:/app/public
    depends_on:
      - db

  # Optional: run web_cms in Docker for dev (Vite with HMR)
  # The app will be available at http://localhost:5173
  web_cms:
    image: node:20-alpine
    container_name: imageaiwrapper-web-cms
    working_dir: /app
    environment:
      CI: "true"
      VITE_API_BASE_URL: http://localhost:8080
      VITE_DEV_AUTH: "1"
    volumes:
      - ../web-cms:/app
      - /app/node_modules
    command: sh -c "corepack enable && corepack prepare pnpm@10.18.3 --activate || true; pnpm install --no-frozen-lockfile; pnpm dev --host 0.0.0.0"
    ports:
      - "5173:5173"
    depends_on:
      - server

  # Production-like build & preview for web_admin (served by Vite preview)
  # The app will be available at http://localhost:4173
  web_cms_preview:
    image: node:20-alpine
    container_name: imageaiwrapper-web-cms-preview
    working_dir: /app
    environment:
      CI: "true"
    volumes:
      - ../web-cms:/app
      - /app/node_modules
    command: >
      sh -c "corepack enable &&
             corepack prepare pnpm@10.18.3 --activate || true;
             pnpm install --no-frozen-lockfile;
             pnpm build;
             pnpm preview --host 0.0.0.0"
    ports:
      - "4173:4173"
    depends_on:
      - server

  pgadmin:
    image: dpage/pgadmin4
    container_name: imageaiwrapper-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@gmail.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - db

volumes:
  db_data:
